<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Quản Lý Trực Xe PC07 Vĩnh Long - Nâng Cao</title>
    <style>
    /* Inlined from style.css */
    body {
        font-family: 'Times New Roman', Times, serif;
        background: #f0f2f5;
        padding: 20px;
    }

    .container {
        max-width: 1200px;
        margin: auto;
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    h2 {
        color: #d32f2f;
        text-align: center;
        border-bottom: 2px solid #d32f2f;
        padding-bottom: 10px;
    }

    .setup-section {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
    }

    .input-area {
        flex: 0.8;
    }

    .list-area {
        flex: 1.2;
        border: 1px solid #ddd;
        border-radius: 8px;
        max-height: 400px;
        overflow: auto;
        background: #fafafa;
    }

    /* Đặt vùng list-area làm relative để các phần tử con sticky hoạt động */
    .list-area {
        position: relative;
    }

    /* Cố định dòng tiêu đề "2. Trạng thái hôm nay:" ở phía trên vùng cuộn */
    .list-area>p {
        position: sticky;
        top: 0;
        margin: 0;
        padding: 12px 8px;
        background: #fafafa;
        z-index: 3;
        border-bottom: 1px solid #ddd;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
        min-width: 420px; /* allow horizontal scroll on small screens */
    }

    th,
    td {
        border-bottom: 1px solid #eee;
        padding: 10px 8px;
        text-align: left;
    }

    /* Đặt header của bảng cố định phía dưới tiêu đề khu vực (top bằng chiều cao tiêu đề) */
    th {
        background: #f8f9fa;
        position: sticky;
        top: 40px;
        z-index: 2;
    }

    .is-absent {
        background-color: #ffebee;
        color: #b71c1c;
        text-decoration: line-through;
    }

    .is-priority {
        background-color: #e3f2fd;
        color: #0d47a1;
        font-weight: bold;
    }

    .locked-row {
        opacity: 0.6;
        pointer-events: none;
    }

    .controls {
        text-align: center;
        margin: 20px 0;
        padding: 15px;
        background: #fff3e0;
        border-radius: 8px;
    }

    button {
        background: #d32f2f;
        color: white;
        border: none;
        padding: 12px 30px;
        cursor: pointer;
        border-radius: 25px;
        font-weight: bold;
    }

    button:hover {
        background: #b71c1c;
    }

    .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
    }

    .vehicle-card {
        border: 2px solid #1976d2;
        border-radius: 8px;
        background: #fff;
    }

    .vehicle-card h3 {
        background: #1976d2;
        color: white;
        margin: 0;
        padding: 10px;
        text-align: center;
    }

    .vehicle-card ul {
        list-style: none;
        padding: 10px;
        margin: 0;
    }

    .vehicle-card li {
        padding: 8px;
        border-bottom: 1px solid #eee;
    }

    .note {
        font-size: 12px;
        color: #666;
        font-style: italic;
    }
    /* CSS để 2 nút nằm thẳng hàng và đều nhau */
.button-group {
    display: flex;
    gap: 10px;        /* Khoảng cách giữa 2 nút */
    margin-top: 10px;
}

.button-group button {
    flex: 1;          /* Cho phép 2 nút có độ dài bằng nhau */
    margin: 0;        /* Xóa margin mặc định nếu có */
    padding: 10px 5px; /* Điều chỉnh lại padding cho gọn */
    white-space: nowrap; /* Không cho chữ xuống dòng trong nút */
}

/* Trên điện thoại nhỏ, nếu nút quá dài có thể cho chồng lên nhau */
@media (max-width: 480px) {
    .button-group {
        flex-direction: column;
    }
}

    /* Responsive tweaks */
    @media (max-width: 992px) {
        .container { padding: 18px; }
        .grid { gap: 12px; }
    }

    @media (max-width: 768px) {
        body { padding: 12px; }
        .setup-section { flex-direction: column; }
        .input-area { order: 1; }
        .list-area { order: 2; max-height: 360px; }
        textarea { height: 120px; }
        table { min-width: 360px; font-size: 13px; }
        .vehicle-card h3 { font-size: 16px; padding: 8px; }
        .vehicle-card li { font-size: 13px; padding: 6px; }
        button { width: 100%; padding: 10px; border-radius: 8px; }
        #editToggleBtn { margin-left: 0; margin-top: 8px; }
    }

    @media (max-width: 420px) {
        .grid { grid-template-columns: 1fr; }
        .container { padding: 12px; }
        h2 { font-size: 18px; }
        th, td { padding: 8px 6px; }
        .list-area { max-height: 300px; }
    }
    @media print {
    /* Ẩn toàn bộ các phần không liên quan */
    body { background: white; padding: 0; }
    .setup-section, .controls, button, .note {
        display: none !important;
    }
    
    /* Căn chỉnh lại vùng in cho đẹp */
    .container {
        box-shadow: none;
        max-width: 100%;
        width: 100%;
        padding: 0;
    }

    h2 {
        font-size: 20px;
        margin-bottom: 20px;
    }

    /* Chia lưới lại để khi in không bị tràn lề */
    .grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr); /* In 2 cột mỗi hàng để chữ to rõ */
        gap: 10px;
    }

    .vehicle-card {
        page-break-inside: avoid; /* Không để card bị cắt đôi khi sang trang */
        border: 1px solid #000;
    }
/* Áp dụng cho cả Web và khi In */
#reserveList {
    display: grid !important;
    /* Ép buộc chia 3 cột bằng nhau */
    grid-template-columns: repeat(3, 1fr) !important; 
    gap: 10px 20px !important;
    list-style: none !important;
    padding: 0 !important;
    margin: 0 !important;
}

/* Định dạng các mục danh sách */
#reserveList li {
    padding: 5px 0 !important;
    border-bottom: 1px solid #ffe0b2 !important;
    font-size: 14px !important;
    /* Giúp tên không bị xuống hàng làm lệch cột */
    white-space: nowrap !important;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* Tinh chỉnh riêng cho chế độ In để không bị mất cột */
@media print {
    #reserveList {
        display: grid !important;
        grid-template-columns: 33% 33% 33% !important; /* Đảm bảo chia đều mặt giấy */
    }
    
    #reserveSection {
        page-break-inside: avoid; /* Không để danh sách dự bị bị cắt đôi sang trang khác */
    }
}
}
    /* End inlined CSS */
</style>
</head>
<body>

<div class="container">
    <h2>Hệ Thống Phân Công Trực Xe PC07</h2>

    <div class="setup-section">
        <div class="input-area">
    <p><strong>1. Danh sách CBCS:</strong></p>
    <textarea id="rawInput" style="width:100%; height:150px;" placeholder="Nhập tên mỗi người một dòng..."></textarea>
    
    <div class="button-group">
       <button onclick="updatePermanentList()" style="background:#555;">Cập Nhật Danh Sách</button>
        <button id="editToggleBtn" onclick="toggleEditLock()" style="background:#616161;">Khóa chỉnh sửa: OFF</button>
    </div>
    
    <p class="note">* Danh sách sẽ tự động lưu lại trên máy này.</p>
</div>
        <div class="list-area">
            <p><strong>2. Trạng thái hôm nay:</strong></p>
            <table id="statusTable">
                <thead>
                    <tr>
                        <th>Tên CBCS</th>
                        <th>Vắng</th>
                        <th>Xe Sau</th>
                    </tr>
                </thead>
                <tbody id="checkboxBody"></tbody>
            </table>
        </div>
    </div>

    <div class="controls button-group">
    <button onclick="generateSchedule()">SẮP XẾP NGẪU NHIÊN</button>
    <button onclick="window.print()" style="background:#2e7d32; margin-left:10px;">IN DANH SÁCH</button>
</div>

    <div id="resultGrid" class="grid"></div>
    
    <div id="reserveSection" style="margin-top: 20px; padding: 15px; background: #fff9e6; border-radius: 8px; border-left: 4px solid #ff9800;">
        <h3 style="margin-top: 0;">Danh Sách Dự Bị</h3>
        <ul id="reserveList" style="list-style: none; padding: 0; margin: 0;"></ul>
    </div>
</div>

    <script>
// Khởi tạo 2 danh sách riêng biệt từ bộ nhớ trình duyệt
let listOld = JSON.parse(localStorage.getItem('listOld')) || [];
let listNew = JSON.parse(localStorage.getItem('listNew')) || [];
let editLocked = false;

// 1. Hàm tải dữ liệu từ 2 file
async function loadFromFile() {
    if (location.protocol === 'file:') return;
    try {
        // Tải file khóa cũ (soldiers1.txt)
        const resp1 = await fetch('soldiers1.txt?t=' + Date.now());
        if (resp1.ok) {
            const text1 = await resp1.text();
            listOld = text1.split('\n').map(s => s.trim()).filter(s => s !== '');
            localStorage.setItem('listOld', JSON.stringify(listOld));
        }

        // Tải file khóa mới (soldiers.txt)
        const resp2 = await fetch('soldiers.txt?t=' + Date.now());
        if (resp2.ok) {
            const text2 = await resp2.text();
            listNew = text2.split('\n').map(s => s.trim()).filter(s => s !== '');
            localStorage.setItem('listNew', JSON.stringify(listNew));
        }
        
        renderTable();
        hienThiDanhSachLenOInput(); // Gọi hàm hiển thị gộp
    } catch (err) {
        console.error("Lỗi tải file:", err);
    }
}
function hienThiDanhSachLenOInput() {
    const inputArea = document.getElementById('rawInput');
    if (inputArea) {
        let textGop = "--- DANH SÁCH KHÓA CŨ ---\n";
        textGop += listOld.join('\n');
        textGop += "\n\n--- DANH SÁCH MỚI ---\n";
        textGop += listNew.join('\n');
        inputArea.value = textGop;
    }
}
function updatePermanentList() {
    const text = document.getElementById('rawInput').value;
    if (!text.trim()) return;

    const lines = text.split('\n').map(s => s.trim()).filter(s => s !== "");
    
    let currentType = 'new'; // Mặc định là lính mới nếu không có tiêu đề
    let tempOld = [];
    let tempNew = [];

    lines.forEach(line => {
        // Kiểm tra nếu dòng là tiêu đề phân loại
        if (line.includes("DANH SÁCH KHÓA CŨ")) {
            currentType = 'old';
        } else if (line.includes("DANH SÁCH MỚI")) {
            currentType = 'new';
        } else if (!line.startsWith("---")) { 
            // Nếu là tên người (không phải dòng kẻ gạch)
            if (currentType === 'old') tempOld.push(line);
            else tempNew.push(line);
        }
    });

    // Cập nhật vào biến toàn cục
    listOld = tempOld;
    listNew = tempNew;

    // Lưu vào localStorage
    localStorage.setItem('listOld', JSON.stringify(listOld));
    localStorage.setItem('listNew', JSON.stringify(listNew));

    // Làm mới bảng hiển thị
    renderTable();
    alert("Đã cập nhật danh sách thành công!");
}
// 2. Hiển thị bảng trạng thái (gộp 2 danh sách để tích vắng/xe sau)
function renderTable() {
    const body = document.getElementById('checkboxBody');
    body.innerHTML = "";

    const createRow = (name, type) => {
        const tr = document.createElement('tr');
        tr.className = `row-${type}`;
        tr.dataset.name = name;
        tr.dataset.type = type; // QUAN TRỌNG: Để hàm sắp xếp biết ai là lính cũ
        
        // Hiển thị nhãn (Khóa cũ) hoặc (Mới) dựa trên biến type truyền vào
        const label = type === 'old' ? 'Khóa cũ' : 'Mới';
        
        tr.innerHTML = `
            <td>${name} <small>(${label})</small></td>
            <td><input type="checkbox" class="absent-cb" onchange="updateRowStyle(this)"></td>
            <td><input type="checkbox" class="priority-cb" onchange="updateRowStyle(this)"></td>
        `;
        return tr;
    };

    // Đổ danh sách lính cũ vào trước, sau đó đến lính mới
    listOld.forEach(name => body.appendChild(createRow(name, 'old')));
    listNew.forEach(name => body.appendChild(createRow(name, 'new')));
    
    applyEditLock();
}

function updateRowStyle(el) {
    const row = el.closest('tr');
    const isAbsent = row.querySelector('.absent-cb').checked;
    const isPriority = row.querySelector('.priority-cb').checked;
    row.classList.remove('is-absent', 'is-priority');
    if (isAbsent) row.classList.add('is-absent');
    else if (isPriority) row.classList.add('is-priority');
}

function shuffle(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
}

// 3. Logic sắp xếp chính
function generateSchedule() {
    let poolOldNormal = [], poolOldPrio = [];
    let poolNewNormal = [], poolNewPrio = [];

    // Phân loại CBCS dựa trên trạng thái đã tích
    const rows = document.querySelectorAll('#checkboxBody tr');
    rows.forEach(row => {
        const name = row.dataset.name;
        const type = row.dataset.type;
        const isAbsent = row.querySelector('.absent-cb').checked;
        const isPriority = row.querySelector('.priority-cb').checked;

        if (!isAbsent) {
            if (type === 'old') {
                if (isPriority) poolOldPrio.push(name); else poolOldNormal.push(name);
            } else {
                if (isPriority) poolNewPrio.push(name); else poolNewNormal.push(name);
            }
        }
    });

    // Trộn ngẫu nhiên (Ưu tiên xe sau sẽ đứng cuối danh sách chờ để được bốc trước nếu cần)
    const finalOld = [...shuffle(poolOldNormal), ...shuffle(poolOldPrio)];
    const finalNew = [...shuffle(poolNewNormal), ...shuffle(poolNewPrio)];

    const licensePlates = ["000.61", "002.39", "000.95", "005.46", "006.81", "001.38", "001.13", "005.45"];
    let gridHtml = "";
    
    // Mảng lưu những người chưa được vào xe để đưa vào dự bị
    let usedOld = 0, usedNew = 0;

    for (let i = 0; i < 8; i++) {
        gridHtml += `<div class="vehicle-card"><h3>XE ${i + 1} - ${licensePlates[i]}</h3><ul>`;
        
        // Vị trí 1 & 2: Lấy từ danh sách Khóa Cũ
        for (let j = 1; j <= 2; j++) {
            let p = finalOld[usedOld++] || "<span style='color:#ccc'>Trống</span>";
            gridHtml += `<li>${j}. ${p}</li>`;
        }
        // Vị trí 3 & 4: Lấy từ danh sách Khóa Mới
        for (let j = 3; j <= 4; j++) {
            let p = finalNew[usedNew++] || "<span style='color:#ccc'>Trống</span>";
            gridHtml += `<li>${j}. ${p}</li>`;
        }
        
        gridHtml += `</ul></div>`;
    }
    document.getElementById('resultGrid').innerHTML = gridHtml;

    // Danh sách dự bị: Những người còn dư của cả 2 nhóm
    const reserveOld = finalOld.slice(usedOld);
    const reserveNew = finalNew.slice(usedNew);
    const allReserve = [...reserveOld, ...reserveNew];

    let reserveHtml = "";
    if (allReserve.length > 0) {
        allReserve.forEach((name, index) => {
            reserveHtml += `<li>${index + 1}. ${name}</li>`;
        });
    } else {
        reserveHtml = "<li style='grid-column: 1/-1; text-align:center;'>Không có dự bị</li>";
    }
    document.getElementById('reserveList').innerHTML = reserveHtml;
}

// Khởi chạy
// Thay thế đoạn kiểm tra listOld/listNew ở cuối file bằng đoạn này:
if (listOld.length > 0 || listNew.length > 0) {
    renderTable();
    hienThiDanhSachLenOInput(); // Đảm bảo hiện ra kể cả khi dùng localStorage
} else {
    loadFromFile();
}

function toggleEditLock() {
    editLocked = !editLocked;
    applyEditLock();
}

function applyEditLock() {
    const toggleBtn = document.getElementById('editToggleBtn');
    if (toggleBtn) toggleBtn.textContent = `Khóa chỉnh sửa: ${editLocked ? 'ON' : 'OFF'}`;
    document.querySelectorAll('.absent-cb, .priority-cb').forEach(cb => cb.disabled = editLocked);
}
/* End inlined JS */
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Quản Lý Trực Xe PC07 Vĩnh Long - Nâng Cao</title>
    <style>
/* Inlined from style.css */
body {
    font-family: 'Times New Roman', Times, serif;
    background: #f0f2f5;
    padding: 20px;
}

.container {
    max-width: 1200px;
    margin: auto;
    background: white;
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

h2 {
    color: #d32f2f;
    text-align: center;
    border-bottom: 2px solid #d32f2f;
    padding-bottom: 10px;
}

.setup-section {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
}

.input-area {
    flex: 0.8;
}

.list-area {
    flex: 1.2;
    border: 1px solid #ddd;
    border-radius: 8px;
    max-height: 400px;
    overflow-y: auto;
    background: #fafafa;
}

/* Đặt vùng list-area làm relative để các phần tử con sticky hoạt động */
.list-area {
    position: relative;
}

/* Cố định dòng tiêu đề "2. Trạng thái hôm nay:" ở phía trên vùng cuộn */
.list-area>p {
    position: sticky;
    top: 0;
    margin: 0;
    padding: 12px 8px;
    background: #fafafa;
    z-index: 3;
    border-bottom: 1px solid #ddd;
}

table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
}

th,
td {
    border-bottom: 1px solid #eee;
    padding: 10px 8px;
    text-align: left;
}

/* Đặt header của bảng cố định phía dưới tiêu đề khu vực (top bằng chiều cao tiêu đề) */
th {
    background: #f8f9fa;
    position: sticky;
    top: 45px;
    z-index: 2;
}

.is-absent {
    background-color: #ffebee;
    color: #b71c1c;
    text-decoration: line-through;
}

.is-priority {
    background-color: #e3f2fd;
    color: #0d47a1;
    font-weight: bold;
}

.locked-row {
    opacity: 0.6;
    pointer-events: none;
}

.controls {
    text-align: center;
    margin: 20px 0;
    padding: 15px;
    background: #fff3e0;
    border-radius: 8px;
}

button {
    background: #d32f2f;
    color: white;
    border: none;
    padding: 12px 30px;
    cursor: pointer;
    border-radius: 25px;
    font-weight: bold;
}

button:hover {
    background: #b71c1c;
}

.grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 15px;
}

.vehicle-card {
    border: 2px solid #1976d2;
    border-radius: 8px;
    background: #fff;
}

.vehicle-card h3 {
    background: #1976d2;
    color: white;
    margin: 0;
    padding: 10px;
    text-align: center;
}

.vehicle-card ul {
    list-style: none;
    padding: 10px;
    margin: 0;
}

.vehicle-card li {
    padding: 8px;
    border-bottom: 1px solid #eee;
}

.note {
    font-size: 12px;
    color: #666;
    font-style: italic;
}
/* End inlined CSS */
</style>
</head>
<body>

<div class="container">
    <h2>Hệ Thống Phân Công Trực Xe PC07</h2>

    <div class="setup-section">
        <div class="input-area">
            <p><strong>1. Danh sách CBCS:</strong></p>
            <textarea id="rawInput" style="width:100%; height:150px;" placeholder="Nhập tên mỗi người một dòng..."></textarea>
            <button onclick="updatePermanentList()" style="margin-top:10px; background:#555;">Cập Nhật Danh Sách</button>
            <button id="editToggleBtn" onclick="toggleEditLock()" style="margin-top:10px; margin-left:10px; background:#616161;">Khóa chỉnh sửa: OFF</button>
            <!-- Nút cập nhật file TXT đã bị loại bỏ để chạy hoàn toàn local -->
            <p class="note">* Danh sách sẽ tự động lưu lại trên máy này.</p>
        </div>
        <div class="list-area">
            <p><strong>2. Trạng thái hôm nay:</strong></p>
            <table id="statusTable">
                <thead>
                    <tr>
                        <th>Tên CBCS</th>
                        <th>Vắng</th>
                        <th>Xe Sau</th>
                    </tr>
                </thead>
                <tbody id="checkboxBody"></tbody>
            </table>
        </div>
    </div>

    <div class="controls">
        <button onclick="generateSchedule()">SẮP XẾP NGẪU NHIÊN</button>
    </div>

    <div id="resultGrid" class="grid"></div>
    
    <div id="reserveSection" style="margin-top: 20px; padding: 15px; background: #fff9e6; border-radius: 8px; border-left: 4px solid #ff9800;">
        <h3 style="margin-top: 0;">Danh Sách Dự Bị</h3>
        <ul id="reserveList" style="list-style: none; padding: 0; margin: 0;"></ul>
    </div>
</div>

    <script>
// Inlined from script.js
// Khởi tạo `masterList` từ `localStorage` nếu có, hoặc mảng rỗng
// Đây là nguồn dữ liệu chính cho các thao tác sau (render, sắp xếp...)
let masterList = JSON.parse(localStorage.getItem('firefighterList')) || [];
// Khi true => chỉnh sửa bị khóa (không thể tương tác với danh sách hiển thị)
let editLocked = false;

function updatePermanentList() {
    const text = document.getElementById('rawInput').value.trim();
    if (!text) return;
    masterList = text.split('\n').map(name => name.trim()).filter(name => name !== "");
    localStorage.setItem('firefighterList', JSON.stringify(masterList));
    renderTable();
}

async function loadFromFile() {
    // Nếu mở trực tiếp bằng file:// thì không cố gắng fetch file (tránh lỗi CORS/HTTP)
    if (location.protocol === 'file:') {
        console.warn('Running from file:// — skipping loadFromFile. Use localStorage or mở bằng server nếu muốn tải soldiers.txt');
        return;
    }
    try {
        const resp = await fetch('soldiers.txt?t=' + Date.now());
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        const text = await resp.text();
        const list = text.split('\n').map(s => s.trim()).filter(s => s !== '');
        if (list.length === 0) {
            alert('File soldiers.txt rỗng.');
            return;
        }
        masterList = list;
        localStorage.setItem('firefighterList', JSON.stringify(masterList));
        document.getElementById('rawInput').value = masterList.join('\n');
        renderTable();
    } catch (err) {
        alert('Không thể tải file soldiers.txt. Hãy mở trang bằng webserver (ví dụ Live Server) hoặc kiểm tra đường dẫn.\n' + err.message);
    }
}

function renderTable() {
    const body = document.getElementById('checkboxBody');
    body.innerHTML = "";
    masterList.forEach((name, index) => {
        const tr = document.createElement('tr');
        tr.id = `row${index}`;
        tr.innerHTML = `
            <td>${name}</td>
            <td><input type="checkbox" class="absent-cb" onchange="updateRowStyle(${index})"></td>
            <td><input type="checkbox" class="priority-cb" onchange="updateRowStyle(${index})"></td>
        `;
        body.appendChild(tr);
    });
    applyEditLock();
}

function applyEditLock() {
    const textarea = document.getElementById('rawInput');
    if (textarea) textarea.disabled = editLocked;
    const rows = document.querySelectorAll('#checkboxBody tr');
    rows.forEach(r => {
        const absent = r.querySelector('.absent-cb');
        const prio = r.querySelector('.priority-cb');
        if (absent) absent.disabled = editLocked;
        if (prio) prio.disabled = editLocked;
        if (editLocked) r.classList.add('locked-row'); else r.classList.remove('locked-row');
    });
    const toggleBtn = document.getElementById('editToggleBtn');
    if (toggleBtn) toggleBtn.textContent = `Khóa chỉnh sửa: ${editLocked ? 'ON' : 'OFF'}`;
}

function updateRowStyle(index) {
    const row = document.getElementById(`row${index}`);
    const isAbsent = row.querySelector('.absent-cb').checked;
    const isPriority = row.querySelector('.priority-cb').checked;
    
    row.className = "";
    if (isAbsent) row.classList.add('is-absent');
    else if (isPriority) row.classList.add('is-priority');
}

function shuffle(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
}

function generateSchedule() {
    let normalGroup = [];
    let priorityGroup = [];

    masterList.forEach((name, index) => {
        const row = document.getElementById(`row${index}`);
        const isAbsent = row.querySelector('.absent-cb').checked;
        const isPriority = row.querySelector('.priority-cb').checked;

        if (!isAbsent) {
            if (isPriority) priorityGroup.push(name);
            else normalGroup.push(name);
        }
    });

    shuffle(normalGroup);
    shuffle(priorityGroup);

    const finalWaitlist = [...normalGroup, ...priorityGroup];

    const licensePlates = ["000.61", "002.39", "000.95", "005.46", "006.81", "001.38", "001.13", "005.45"];

    let gridHtml = "";
    for (let i = 0; i < 8; i++) {
        gridHtml += `<div class="vehicle-card"><h3>XE ${i + 1} - ${licensePlates[i]}</h3><ul>`;
        for (let j = 0; j < 4; j++) {
            let p = finalWaitlist[i * 4 + j] || "<span style='color:#ccc'>---</span>";
            gridHtml += `<li>${j + 1}. ${p}</li>`;
        }
        gridHtml += `</ul></div>`;
    }
    document.getElementById('resultGrid').innerHTML = gridHtml;
    
    const reserveList = finalWaitlist.slice(32);
    let reserveHtml = "";
    if (reserveList.length > 0) {
        reserveList.forEach((name, index) => {
            reserveHtml += `<li>${index + 1}. ${name}</li>`;
        });
    } else {
        reserveHtml = "<li style='color: #999;'>Không có dự bị</li>";
    }
    document.getElementById('reserveList').innerHTML = reserveHtml;
}

function toggleEditLock() {
    editLocked = !editLocked;
    applyEditLock();
}

// Nếu đã có dữ liệu lưu trước đó, điền vào textarea và render bảng ngay
if (masterList.length > 0) {
    document.getElementById('rawInput').value = masterList.join('\n');
    renderTable();
} else {
    loadFromFile().then(() => {
        applyEditLock();
    });
}
/* End inlined JS */
</script>

</body>
</html>